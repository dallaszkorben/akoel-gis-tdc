 <!DOCTYPE html>
<html>
	<head>

		<!-- A lekért adatok megjelenítését szabályozza TABLE-ben -->
		<style type="text/css">
		    table.template, th.template, td.template {				
				border:1px solid #e5e5e5;
				border-collapse:collapse;
				font-family: arial;          
				font-size: 12;            
				color: #333333
		    }             
	    th.template, td.template {
			valign: top;
			text-align: left;
	    }          
	    th.template {
			background-color: #aed7ff
	    }
	    caption.template {
			border:1px solid #e5e5e5;
			border-collapse:collapse;
			font-family: arial;          
			font-weight: bold;
			font-size: 14;      
			text-align: left;      
			color: #333333;        
	    }
        </style>

		<title>TDC</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<script type="text/javascript" src="/tdc/proj4js/lib/proj4js.js"></script>
		<script type="text/javascript" src="/tdc/openlayers/OpenLayers.js"></script> 
		<script type="text/javascript" src="/tdc/jquery/jquery-1.8.1.js"></script>
		<script type="text/javascript" src="/tdc/xmlhttprequest/XMLHttpRequest.js"></script>
		<script type="text/javascript">

		// EOV vetület proj4-es definíciója. Figyelem: az EPSG adatbázisban hibásan szerepel, a dátumtranszformáció hiányzik belőle!
		Proj4js.defs["EPSG:2370"] = "+title=Hungarian EOV EPSG:2370 +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +x_0=650000 +y_0=200000 +ellps=GRS67 +datum=HD72 +towgs84=57.01,-69.97,-9.29 +units=m +no_defs"

		//MAP fajl eleresi utvonala
		var urlMap = "http://localhost/cgi-bin/mapserv?map=/home/akoel/Projects/tdc/svn/www/htdocs/tdc.map";

		//Vetuletek
//	var wgs84=new OpenLayers.Projection('EPSG:4326');
		var hd72=new OpenLayers.Projection('EPSG:2370');

		//MAP objektum
		var map;
		var popup;

		//View layer
		var emptyBaseLayer;
		var parcelViewLayer;
		var buildingViewLayer;
		var buildingIndividualUnitViewLayer;
		var pointViewLayer;

		//Query layer
		var identifyLayer;
		var queryOwnerBuildingIndividualUnitLayer;
		var queryObjectPointsBuildingIndividualUnitLayer;
		var queryOwnerParcelLayer;
		var queryProjectonPointParcelLayer;
		var queryOwnerBuildingLayer;
		var queryProjectionPointsBuildingLayer;
		var queryObjectPointsBuildingLayer;
		var queryX3DBuildingLayer;

		//Szint megjelenítést választó mezők
		var buildingLevelSelector;
		var underpassLevelSelector;

		var foundLayer = false;

		function init() {

			//-------------
			// MAP objektum
			//-------------
			map = new OpenLayers.Map('mapDiv',
			{
				projection: "EPSG:2370",
			//maxExtent: new OpenLayers.Bounds(410000, 45000, 950000, 360000), //Ez a teljes magyarorszag
//			maxExtent: new OpenLayers.Bounds(645407, 227808, 645670, 227959),  //Ez pedig a kijelolt telek
				maxExtent: new OpenLayers.Bounds(645200, 227760, 645700, 228050),  //Ez pedig a kijelolt telek
				//maxExtent: new OpenLayers.Bounds(645200, 227760, 645700, 228050),  //Ez pedig a kijelolt telek
			//maxResolution: 901, //Ez magyarorszagra vonatkozo meret
				maxResolution: 0.8,
				units: "m"
			});

			//---------
			// Controls
			//---------
			//map.addControl(new OpenLayers.Control.OverviewMap());

			//Layerek ki/be kapcsolasa
			//map.addControl(new OpenLayers.Control.LayerSwitcher()); //A térképen belül
			map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerSwitcherDiv')}));

			//Leptek
			var scaleLine = new OpenLayers.Control.ScaleLine();
			map.addControl( scaleLine );

			//pozicio Control
			var posControl = new OpenLayers.Control.MousePosition({'numDigits':2, 'displayProjection': hd72, 'emptyString':''});
			map.addControl( posControl );

			//Meretarany	    
			var scaleControl = new OpenLayers.Control.Scale();
			map.addControl( scaleControl);
	    
//		var attribControl = new OpenLayers.Control.Attribution();
//		map.addControl( attribControl );


			//--------------------------------------------------------------------------------------------
			// A lathatosagi layerek
			//
			//  MapServer -nek kell lennie
			//--------------------------------------------------------------------------------------------

			emptyBaseLayer = new OpenLayers.Layer("",{isBaseLayer: true},{displayInLayerSwitcher: false});

			parcelViewLayer = new OpenLayers.Layer.WMS( 
				"Földrészlet", 
				urlMap,
				{ layers:  "view_parcel", format: 'image/png' },//, selected_nid: null },
				{ isBaseLayer: false, visibility: true, opacity: 1.0, transparent: 'true' }
			);

			buildingViewLayer = new OpenLayers.Layer.WMS( 
				"Épület", 
				urlMap,
				{ layers:  "view_building", format: 'image/png' },//, selected_nid: null },
				{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true' }				
			);

			buildingIndividualUnitViewLayer = new OpenLayers.Layer.WMS( 
				"Lakások", 
				urlMap,
				{ layers:  "view_building_individual_unit", format: 'image/png' },//, visible_building_level: '0.0', selected_nid: null },
				{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true' }				
			);

			pointViewLayer = new OpenLayers.Layer.WMS( 
				"Pontok", 
				urlMap,
				{ layers:  "view_point", format: 'image/png' },//, visible_building_level: '0.0', selected_nid: null },
				{ isBaseLayer: false, alpha:true, visibility: false, opacity: 1.0, transparent: 'true' }				
			);

			//----------------------------------------------------------------------------------------------------------------
			// Lekerdezo layerek
			//
			// WMS -nek kell lennie
			//---------------------------------------------------------------------------------------------------------------
			//visibility: false - Nem látható
			//displayInLayerSwithcer: false - Nem lesz látható a Layer Swicherben
			//----------------------------------------------------------------------------------------------------------------
			identifyLayer = new OpenLayers.Layer.WMS( 
				"Közös kérés", 
				urlMap,
				{ layers:  "identify_point,identify_building_individual_unit,identify_building,identify_parcel", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryOwnerBuildingIndividualUnitLayer = new OpenLayers.Layer.WMS( 
				"query_owner_building_individual_unit", 
				urlMap,
				{ layers:  "query_owner_building_individual_unit", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryObjectPointsBuildingIndividualUnitLayer = new OpenLayers.Layer.WMS( 
				"query_object_points_building_individual_unit", 
				urlMap,
				{ layers:  "query_object_points_building_individual_unit", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryOwnerParcelLayer = new OpenLayers.Layer.WMS( 
				"query_owner_parcel", 
				urlMap,
				{ layers:  "query_owner_parcel", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);
		
			queryProjectionPointsParcelLayer= new OpenLayers.Layer.WMS( 
				"query_projection_points_parcel", 
				urlMap,
				{ layers:  "query_projection_points_parcel", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryOwnerBuildingLayer= new OpenLayers.Layer.WMS( 
				"query_owner_building", 
				urlMap,
				{ layers:  "query_owner_building", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryProjectionPointsBuildingLayer= new OpenLayers.Layer.WMS( 
				"query_projection_points_building", 
				urlMap,
				{ layers:  "query_projection_points_building", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryObjectPointsBuildingLayer= new OpenLayers.Layer.WMS( 
				"query_object_points_building", 
				urlMap,
				{ layers:  "query_object_points_building", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			queryX3DBuildingLayer= new OpenLayers.Layer.WMS( 
				"query_object_points_building", 
				urlMap,
				{ layers:  "query_x3d_building", format: 'image/png' },
				{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
			);

			//Lekérdező layer-ek
			map.addLayer(identifyLayer);
			map.addLayer(queryOwnerBuildingIndividualUnitLayer);
			map.addLayer(queryObjectPointsBuildingIndividualUnitLayer);
			map.addLayer(queryOwnerParcelLayer);
			map.addLayer(queryProjectionPointsParcelLayer);
			map.addLayer(queryOwnerBuildingLayer);
			map.addLayer(queryProjectionPointsBuildingLayer);
			map.addLayer(queryObjectPointsBuildingLayer);
			map.addLayer(queryX3DBuildingLayer);

			//Megjelenithető layer-ek
			//Fontos a sorrend. A kovetkezo mindig az elozo felett van
			map.addLayer(emptyBaseLayer);
			map.addLayer(parcelViewLayer);		
			map.addLayer(buildingViewLayer);
			map.addLayer(buildingIndividualUnitViewLayer);
			map.addLayer(pointViewLayer);

			//===========	//
			//				//
			// Esemenykezeles	//
			//				//
			//===========	//
	    
			//---------------------------------------------------
			//Pozicio megjelenitese esemény
			//---------------------------------------------------
			map.events.register("click", map, function(e){
	        
/*			//Pozicio az ablak koordinata rendszereben
			var pxPos=map.events.getMousePosition(e);
	        
			//Pozicio az aktuális vetületi rendszerben
			var projPos=map.getLonLatFromPixel(pxPos);
	        
			//Pozicio wgs84 foldrajzi koordinatarendszerben
			var wgs84Pos=projPos.clone().transform(hd72,wgs84);
	        
			//Ellenorzeskepp visszaszamolun. termeszetesen ez nem kell
			var eovPos=projPos.clone().transform(hd72,hd72);
	                
			document.getElementById('posDiv').innerHTML="Page position: " + pxPos + "<br>" + "EOV: " + projPos + "<br>" + "WGS84: " + wgs84Pos + "<br>" + "hd72: " + eovPos;
*/

			}  );

			//---------------------------------
			//Kivalasztas esemény
			//---------------------------------
			//
			// Az összes layeren keres
			// Igy tehát, ha egy pontban egymás alatt több layer is található, akkor az mind bekerül a találati listába
			// Készöbb fogom leválogatni hogy melyik találatra van szükségem
			map.events.register("click", map, function(e){
				var getInfoCommonURL=identifyLayer.getFullRequestString({
				REQUEST: "GetFeatureInfo",
				EXCEPTIONS: "application/vnd.ogc.se_xml",
				FORMAT: 'png',
				BBOX: map.getExtent().toBBOX(),
				X: e.xy.x,
				Y: e.xy.y,
				INFO_FORMAT: 'text/html',
				QUERY_LAYERS:  "identify_point,identify_building_individual_unit,identify_building,identify_parcel", //Azok a layer-ek, amikrol infot akarok
				FEATURE_COUNT: 1,
				WIDTH: map.size.w,
				HEIGHT: map.size.h });
				OpenLayers.Request.POST({ url: getInfoCommonURL, callback: function(response){ highlightResult(response, e.xy )}});			
			});

		   	 //Terkep merete a maximalisra-Maximum ekkora lehet egy pixel
			map.zoomToMaxExtent();
	    
			//Épület szintmegjelenítést választó mező
			buildingLevelSelector = document.getElementById("building_level_selection");
			buildingLevelSelector.onchange=function(){

				//Ha valtoztatom a megjelenítendő épület szintet, akkor kirajzoltatom az aktuálisat
				buildingIndividualUnitViewLayer.params.visible_building_level=buildingLevelSelector.options[buildingLevelSelector.selectedIndex].value;

				//Ezt majd egy kicsit kidolgozottabban kell megoldani  TICKET
				clearAndRedraw();
			}

			//Aluljáró szintmegjelenítést választó mező
			underpassLevelSelector = document.getElementById("underpass_level_selection");
			underpassLevelSelector.onchange=function(){
			//Ha valtoztatom a megjelenítendő épület szintet, akkor kirajzoltatom az aktuálisat
//			buildingIndividualUnitViewLayer.params.visible_building_level=underpassLevelSelector.options[underpassLevelSelector.selectedIndex].value;
//			buildingIndividualUnitViewLayer.redraw( true );
			}
 
			//Alapállapotot állítom a mezőket
			resetValues();

		}; //Vége az incializáló függvénynek

		//-------------------------------------------------
		// Kiemelo fuggveny+azonosítás
		//-------------------------------------------------
		function highlightResult(response, xy){
			var xmlDoc = $.parseXML( "<block>" + response.responseText + "</block>" );
			var objs = $( $(xmlDoc)[0] ).find("object" );
			var toDiv = "<html><head></head><body>Kivalasztott elemek<br>"
			var identify_name;
			var identify_nid;
			var immovable_type;
			var identify_settlement;
			var identify_hrsz;
			var identify_levels;
			var identify_registered_area;
			var identify_measured_area;

			var building_individual_unit_level;
			var layerToQuery = "";
			var hasSelected = false;

			clearDivs();
	 		clearBaloon();
			clearSelection();

			//A kurzor poziciójának átszámítása vetületi koordinátára
			var projPos = map.getLonLatFromPixel( {x:xy.x, y:xy.y} );

			//Ha kattintottam egy objektumra
			if( objs.length > 0 ){

				//Ha mar van nyitva popup, akkor azt lezarja
				if( popup ){
					map.removePopup(popup);
				}
			
				//Ha a kijelölt objektum más objektummal tulajdoni viszonyban van
				//De ehhez előbb fentről lefele meg kell találni a kijelölt objektumot
				//Például ha egy házra kattintottam és az látható volt a térképen, akkor azt és az azzal kapcsolatos földterületet kell kijelölni  ???????????

				//Jelzem, hogy meg nem volt kivalasztott elem
				hasSelected = false;

				        ///////////////////////////////////////////////////////////////////////////////////////////////////////////
				      ////////////////////                                                       ////////////////////////////////
				    ////////////////////                        POINT                    ////////////////////////////////
				  /////////////////////                                                       ////////////////////////////////
				////////////////////////////////////////////////////////////////////////////////////////////////////////////
				for( i = 0; i< objs.length; i++){

					//Álatlános paraméterek, Ezek már itt is léteznek
					identify_name = $(objs[ i ]).attr("identify_name");
					identify_nid = $(objs[ i ]).find("identify_nid")[0].textContent;

					if( identify_name == "sv_survey_point"  && pointViewLayer.getVisibility()){
					
						//Ezek pont specifikus paraméterek, csak itt lehetek biztos benne, hogy léteznek
						identify_point_name = $(objs[ i ]).find("identify_point_name")[0].textContent;
						identify_point_description = $(objs[ i ]).find("identify_point_description")[0].textContent;
						identify_point_quality = $(objs[ i ]).find("identify_point_quality")[0].textContent;
						identify_point_measured_date = $(objs[ i ]).find("identify_point_measured_date")[0].textContent;
						identify_point_dimension = $(objs[ i ]).find("identify_point_dimension")[0].textContent;
						identify_point_x = $(objs[ i ]).find("identify_point_x")[0].textContent;
						identify_point_y = $(objs[ i ]).find("identify_point_y")[0].textContent;
						identify_point_h = $(objs[ i ]).find("identify_point_h")[0].textContent;

						//=================================================
						//=                                                                           =
						//=   Kozvetlen adatok buborekban valo megjelenitese =
						//=                                                                          =
						//================================================

						//Buborkék előkészítése		
						var result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Pont</center><br>";
						result += "Pont megnevezése: <b>" + identify_point_name + "</b><br>";
						result += "Pontleírás: <b>" + identify_point_description  + "</b><br>";
						result += "Pont minőség: <b>" + identify_point_quality + "</b> <br>";
						result += "Dimenzió: <b>" + identify_point_dimension + "</b><br>";
						result += "Mérés időpontja: <b>" + identify_point_measured_date + "</b><br>";
						result += "x: <b>" + identify_point_x + "</b><br>";
						result += "y: <b>" + identify_point_y + "</b><br>";
						if(identify_point_dimension=3){
							result += "h: <b>" + identify_point_h + "</b>";
						}
	
						/*
						//Eredmeny egy buborekba a kivalasztott ponthoz
						popup = new OpenLayers.Popup.FramedCloud(
			                        "chick", 
			                        map.getLonLatFromPixel( xy ),
			                        null, //new OpenLayers.Size(100,300),
			                        result,
			                        null,
			                        true,
			                        null
	                   );

						//Elhelyezi a buborekot-a terkepen
						map.addPopup( popup ); */

						//==================================
						//=                                                  =
						//=   Kozvetlen adatok megjelenitese =
						//=                                                 =
						//================================

						document.getElementById( "objectDataDIV" ).innerHTML = result;

						//Akkor a kijelolest allitja
						pointViewLayer.params.selected_nid =  identify_nid;

						//Jelzem, hogy van kivalasztott elem
						hasSelected = true;
						break
					}
				}


				        ///////////////////////////////////////////////////////////////////////////////////
				      ////////////////////                                                       ////////////////////////////////
				    ////////////////////  BUILDING INDIVIDUAL UNIT   ////////////////////////////////
				  /////////////////////                                                       ///////////////////////////////
				//////////////////////////////////////////////////////////////////////////////////
				for( i = 0; !hasSelected && i< objs.length; i++){

					//Álatlános paraméterek, Ezek már itt is léteznek
					identify_name = $(objs[ i ]).attr("identify_name");
					identify_nid = $(objs[ i ]).find("identify_nid")[0].textContent;				

					        // / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
					      // / / / /                                                                           / / / / / 
					    // / / / /      Ha lakás volt és a layer-en latszik a lakás       / / / / /  
					  // / / / /                                                                          / / / / / 
					// / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / /  

					if( identify_name == "im_building_individual_unit"  && buildingIndividualUnitViewLayer.getVisibility()){

						//Ezek társasházi lakás specifikus paraméterek, csak itt lehetek biztos benne, hogy léteznek
						identify_level = $(objs[ i ]).find("identify_level")[0].textContent;
						identify_settlement = $(objs[ i ]).find("identify_settlement")[0].textContent;
						identify_hrsz = $(objs[ i ]).find("identify_hrsz")[0].textContent;
						identify_registered_area = $(objs[ i ]).find("identify_registered_area")[0].textContent;
						identify_measured_area = $(objs[ i ]).find("identify_measured_area")[0].textContent;

						//Ha  a látható szinten választottam
						if( buildingIndividualUnitViewLayer.params.visible_building_level == identify_level ){

							//=================================================
							//=                                                                           =
							//=   Kozvetlen adatok buborekban valo megjelenitese =
							//=                                                                          =
							//================================================

							//Buborkék előkészítése		
							var result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Társasházi lakás</center><br>";
							result += "Város: <b>" + identify_settlement + "</b><br>";
							result += "Hrsz: <b>" + identify_hrsz  + "</b><br>";
							result += "Nyilvántartott terület: <b>" + Math.round(identify_registered_area) + "</b> " + "m2<br>";
							result += "Mért terület: <b>" + Math.round(identify_measured_area) + "</b> " + "m2";
	
							showBobble( result, projPos );

							//==================================
							//=                                                  =
							//=   Kozvetlen adatok megjelenitese =
							//=                                                 =
							//================================

							document.getElementById( "objectDataDIV" ).innerHTML = result;

							//==============================
							//=                                            =
							//=   Tulajdonosok megjelenitese =
							//=                                           =
							//============================

							//Paraméter átadás-csak a kivalasztott lakas tulajdonosait adja vissza
							queryOwnerBuildingIndividualUnitLayer.params.selected_nid=identify_nid;
							queryOwnerBuildingIndividualUnitLayer.params.visible_building_level=buildingIndividualUnitViewLayer.params.visible_building_level;

							//Owner list query  a kivalasztott objektumrol
							var getOwnerInfo=queryOwnerBuildingIndividualUnitLayer.getFullRequestString({
								REQUEST: "GetFeatureInfo",
								EXCEPTIONS: "application/vnd.ogc.se_xml",
								FORMAT: 'png',
								BBOX: map.getExtent().toBBOX(),
								X: xy.x,
								Y: xy.y,
								INFO_FORMAT: 'text/html',
								QUERY_LAYERS: 'query_owner_building_individual_unit',
								FEATURE_COUNT: 100,
								WIDTH: map.size.w,
								HEIGHT: map.size.h });

							//A query elküldése
							OpenLayers.Request.POST({ url: getOwnerInfo, callback: function(response){ 

								//Tulajdonosi viszonyok megjelenitese
								document.getElementById( "ownerListDIV" ).innerHTML = response.responseText;
							}});

							//===================================
							//=                                                    =
							//= 3D objektum Pontok megjelenitese =
							//=                                                   =
							//=================================
							queryObjectPointsBuildingIndividualUnitLayer.params.selected_nid=identify_nid;
							queryObjectPointsBuildingIndividualUnitLayer.params.visible_building_level=buildingIndividualUnitViewLayer.params.visible_building_level;

							//Owner list query  a kivalasztott objektumrol
							var getPointInfo=queryObjectPointsBuildingIndividualUnitLayer.getFullRequestString({
								REQUEST: "GetFeatureInfo",
								EXCEPTIONS: "application/vnd.ogc.se_xml",
								FORMAT: 'png',
								BBOX: map.getExtent().toBBOX(),
								X: xy.x,
								Y: xy.y,
								INFO_FORMAT: 'text/html',
								QUERY_LAYERS: 'query_object_points_building_individual_unit',
								FEATURE_COUNT: 100,
								WIDTH: map.size.w,
								HEIGHT: map.size.h });

							//A query elküldése
							OpenLayers.Request.POST({ url: getPointInfo, callback: function(response){ 

								//Pontok megjelenitese
								document.getElementById( "objectPointsListDIV" ).innerHTML = response.responseText;
							}});

							buildingIndividualUnitViewLayer.params.selected_nid =  identify_nid;

							//Jelzem, hogy van kivalasztott elem
							hasSelected = true;
							break
						}
					}
				}//BUILDING INDIVIDUAL UNIT for

						   /////////////////////////////////////////////////////////////////////////////////
				        ////////////////////                                                       ///////////////////////////////
				     ////////////////////                   BUILDING                  ////////////////////////////////
				   /////////////////////                                                       //////////////////////////////
				//////////////////////////////////////////////////////////////////////////////////
				for( i = 0; !hasSelected && i< objs.length; i++){
	
					//Álatlános paraméterek, Ezek már itt is léteznek
					identify_name = $(objs[ i ]).attr("identify_name");
					identify_nid = $(objs[ i ]).find("identify_nid")[0].textContent;
				
					        // / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
					      // / / / /                                                                           / / / / / 
					    // / / / /       Ha ház volt és a layer-en latszik a ház            / / / / /  
					  // / / / /                                                                           / / / / / 
					// / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 

					if( identify_name == "im_building"  && buildingViewLayer.getVisibility() ){

						//Ezek az épület specifikus paraméterei, csak itt lehetek biztos benne, hogy léteznek
						immovable_type = $(objs[ i ]).find("immovable_type")[0].textContent;
						identify_settlement = $(objs[ i ]).find("identify_settlement")[0].textContent;
						identify_hrsz = $(objs[ i ]).find("identify_hrsz")[0].textContent;
						identify_levels = $(objs[ i ]).find("identify_levels")[0].textContent;
						identify_registered_area = $(objs[ i ]).find("identify_registered_area")[0].textContent;
						identify_measured_area = $(objs[ i ]).find("identify_measured_area")[0].textContent;

						//=================================================
						//=                                                                           =
						//=   Kozvetlen adatok buborekban valo megjelenitese =
						//=                                                                          =
						//================================================

						//Buborkék előkészítése		
						var result = "Város: <b>" + identify_settlement + "</b><br>";
						result += "Hrsz: <b>" + identify_hrsz  + "</b><br>";
						result += "Szintek száma: <b>" + identify_levels + "</b><br>";
						result += "Nyilvántartott terület: <b>" + Math.round(identify_registered_area) + "</b> " + "m2<br>";
						result += "Mért terület: <b>" + Math.round(identify_measured_area) + "</b> " + "m2";

						//Ha "2. Foldreszlet hazzal" volt
						if( immovable_type == 2 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Épület a földrészlettel</center><br>" + result;

						//Ha "3. Foldreszlet kulonallo hazzal" volt
						}else if( immovable_type == 3 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>EÖI-ú épület </center><br>" + result;

						//Ha "4. Tarsas haz" volt
						}else if( immovable_type == 4 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Társasházi ingatlan</center><br>" + result;

						}

						showBobble( result, projPos );

						//==================================
						//=                                                  =
						//=   Kozvetlen adatok megjelenitese =
						//=                                                 =
						//================================

						document.getElementById( "objectDataDIV" ).innerHTML = result;

						//===============================
						//=                                             =
						//=   Tulajdonosok megjelenitese  =
						//=                                            =
						//=============================

						//Paraméter átadás-csak a kivalasztott lakas tulajdonosait adja vissza
						queryOwnerBuildingLayer.params.immovable_type=immovable_type;
						queryOwnerBuildingLayer.params.selected_nid=identify_nid;

						//Owner list query  a kivalasztott objektumrol
						var getOwnerInfo=queryOwnerBuildingLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_owner_building',
							FEATURE_COUNT: 100,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						//A query elküldése
						OpenLayers.Request.POST({ url: getOwnerInfo, callback: function(response){ 

							//Tulajdonosi viszonyok megjelenitese
							document.getElementById( "ownerListDIV" ).innerHTML = response.responseText;
						}});

						//===============================
						//=                                              =
						//=  Vetületi Pontok megjelenitese =
						//=                                             =
						//==============================
						queryProjectionPointsBuildingLayer.params.selected_nid=identify_nid;

						//Owner list query  a kivalasztott objektumrol
						var getPointInfo=queryProjectionPointsBuildingLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_projection_points_building',
							FEATURE_COUNT: 100,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						//A query elküldése
						OpenLayers.Request.POST({ url: getPointInfo, callback: function(response){ 

							//Pontok megjelenitese
							document.getElementById( "projectionPointsListDIV" ).innerHTML = response.responseText;
						}});

						//=========================
						//=                                                            =
						//=  3D objektum Pontok megjelenitese =
						//=                                                            =
						//=========================
						queryObjectPointsBuildingLayer.params.selected_nid=identify_nid;

						//Owner list query  a kivalasztott objektumrol
						var getPointInfo=queryObjectPointsBuildingLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_object_points_building',
							FEATURE_COUNT: 100,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						//A query elküldése
						OpenLayers.Request.POST({ url: getPointInfo, callback: function(response){ 

							//Pontok megjelenitese
							document.getElementById( "objectPointsListDIV" ).innerHTML = response.responseText;
						}});

						//=========================
						//=                                     =
						//=  X3D Létrehozása          =
						//=                                     =
						//=========================

//						var projPos = map.getLonLatFromPixel( {x:xy.x, y:xy.y} );

						//Egy php script fogja legyartani az x3d fajlt az elkuldott koordinata es kivalasztott objektum alapjan
						$.ajax({
							type: "GET",
							url: "http://localhost/tdc/htdocs/proba.php",
							contentType: "text/html",
							dataType: "html",
							data: { 	selected_name: identify_name, selected_nid: identify_nid, immovable_type: immovable_type, x: xy.x, y: xy.y, lon: projPos.lon, lat: projPos.lat },
							async:false,
							success: successX3D,
							error: errorX3D
						});

///////////////////

						//Akkor a kijelolest allitja
						buildingViewLayer.params.selected_nid =  identify_nid;

						//Jelzem, hogy van kivalasztott elem
						hasSelected = true;
						break
					}
				}//BUILDING for


				           //////////////////////////////////////////////////////////////////////////////////
				         ////////////////////                                                       ///////////////////////////////
				      ////////////////////                  PARCEL                        ////////////////////////////////
				   ////////////////////                                                       ////////////////////////////////
				///////////////////////////////////////////////////////////////////////////////////
				for( i = 0; !hasSelected && i< objs.length; i++){
		
					identify_name = $(objs[ i ]).attr("identify_name");
					identify_nid = $(objs[ i ]).find("identify_nid")[0].textContent;				

					          // / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / /
					        // / / / /                                                                                   / / / / / 
					      // / / / /      Ha földrészlet volt és a layer-en latszik a lakás       / / / / /  
					    // / / / /                                                                                   / / / / / 
					  // / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
					// Ha földrészlet volt és látszik a földrészlet (persze ez mindig látszik-de azért mégis vizsgálom)
					if( identify_name == "im_parcel"  && parcelViewLayer.getVisibility() ){

						//Általános paraméterek
						immovable_type = $(objs[ i ]).find("immovable_type")[0].textContent;
						identify_settlement = $(objs[ i ]).find("identify_settlement")[0].textContent;
						identify_hrsz = $(objs[ i ]).find("identify_hrsz")[0].textContent;
						identify_registered_area = $(objs[ i ]).find("identify_registered_area")[0].textContent;
						identify_measured_area = $(objs[ i ]).find("identify_measured_area")[0].textContent;

						//Buborkék előkészítése		
						var result = "Város: <b>" + identify_settlement + "</b><br>";
						result += "Hrsz: <b>" + identify_hrsz  + "</b><br>";
						result += "Nyilvántartott terület: <b>" + Math.round(identify_registered_area) + "</b> " + "m2<br>";
						result += "Mért terület: <b>" + Math.round(identify_measured_area) + "</b> " + "m2<br>";
	
						//Ha "1. Foldreszlet" volt
						if( immovable_type == 1 ){
					
							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Földrészlet</center><br>" + result;

						//Ha "2. Foldreszlet hazzal" volt
						}else if( immovable_type == 2 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Földrészlet házzal</center><br>" + result;

						//Ha "3. Foldreszlet kulonallo hazzal" volt
						}else if( immovable_type == 3 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Földrészlet (EÖI-nal a területén)</center><br>" + result;

						//Ha "4. Tarsas haz" volt
						}else if( immovable_type == 4 ){

							result = "<center style='font-family: arial; font-size: 14; font-weight: bold'>Földrészlet - társasházi ingatlan</center><br>" + result;

						}

						showBobble( result, projPos );

						//==================================
						//=                                                  =
						//=   Kozvetlen adatok megjelenitese =
						//=                                                 =
						//================================

						document.getElementById( "objectDataDIV" ).innerHTML = result;

						//==============================
						//=                                            =
						//=   Tulajdonosok megjelenitese =
						//=                                           =
						//============================

						//Paraméter átadás-csak a kivalasztott lakas tulajdonosait adja vissza
						//Atadom az immovable_type-ot is, mert igy könnyebb az sql select, ha tudom eleve, hogy milyen típusú
						queryOwnerParcelLayer.params.immovable_type=immovable_type;
						queryOwnerParcelLayer.params.selected_nid=identify_nid;

						//Owner list query  a kivalasztott objektumrol
						var getOwnerInfo=queryOwnerParcelLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_owner_parcel',
							FEATURE_COUNT: 1000,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						//A query elküldése
						OpenLayers.Request.POST({ url: getOwnerInfo, callback: function(response){ 

							//Tulajdonosi viszonyok megjelenitese
							document.getElementById( "ownerListDIV" ).innerHTML = response.responseText;

						}});

						//=================================
						//=                                                 =
						//=   Vetületi Pontok megjelenitese   =
						//=                                                =
						//===============================
						queryProjectionPointsParcelLayer.params.selected_nid=identify_nid;

						//Owner list query  a kivalasztott objektumrol
						var getPointInfo=queryProjectionPointsParcelLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_projection_points_parcel',
							FEATURE_COUNT: 100,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						//A query elküldése
						OpenLayers.Request.POST({ url: getPointInfo, callback: function(response){ 

							//Pontok megjelenitese
							document.getElementById( "projectionPointsListDIV" ).innerHTML = response.responseText;
						}});

						//Akkor a kijelolest allitja
						parcelViewLayer.params.selected_nid =  identify_nid;

						//Jelzem, hogy van kivalasztott elem
						hasSelected = true;
						break
					}
				}//PARCEL for
			}

			redraw();

		}//highlightResult(

		//
		// Buborék megjelenítése
		//
		function showBobble( result, position ){

			if( document.forms.control['bubble'].checked ){

				//Eredmeny egy buborekba a kivalasztott ponthoz
				popup = new OpenLayers.Popup.FramedCloud(
					"chick", 
					position,
					null, 
					result,
					null,
					true,
					null
				);

				//Elhelyezi a buborekot-a terkepen
				map.addPopup( popup );

			}

		}

		//
		//Sikeres X3D gyártás után
		//
		function successX3D( data, status, req ){

			if( status =="success")

				//Link megjelenitese
				var linkText = "<a id='x3dhref' href='" + data + "'>X3D modell</a>";
				document.getElementById( "X3DLinkDIV" ).innerHTML = linkText;

				//Ha engedélyezem a modell direkt megjelenítését
				if( document.forms.control['3dmodel'].checked ){

					window.location=document.getElementById('x3dhref').href;
//					window.open( data );
				}

			}

		//
		//Sikertelen X3D gyártás után
		//
		function errorX3D( data, status, req ){
			alert( 'hiba: ' + data.responseText + ' status: ' + status);
		}

/*
var escaped_one_to_xml_special_map = {
	'&#39;': '\'',
	'&quot;': '"',
	'&lt;': '<',
	'&gt;': '>'
};


function decodeXml(string) {
	return string.replace(/(&#39;|&lt;|&gt;|&quot;)/g,
		function(str, item) {
			return escaped_one_to_xml_special_map[item];
		});
}
*/
		//
		// Alapállapotba állítom a mezőket
		//
		function resetValues(){

			//Parameterek a MAP fajlnak, ha WMS layert hasznalok MapServer helyett, mert akkor nem ismeri fel, hogy a parametereket at kell adni
			buildingIndividualUnitViewLayer.params.visible_building_level='0.0';

			clearSelection();
	
			clearDivs();

			//Beállítom az épület szintválasztót földszintre
			for( var i=0; i<buildingLevelSelector.length; i++){

				if( buildingLevelSelector.options[i].value == buildingIndividualUnitViewLayer.params.visible_building_level ){
					buildingLevelSelector.selectedIndex=i;
					break;
				}
			}		

			//Beállítom az aluljáró szintválasztót -1
			for( var i=0; i<underpassLevelSelector.length; i++){

				if( underpassLevelSelector.options[i].value == "-1.0" ){
					underpassLevelSelector.selectedIndex=i;
					break;
				}
			}		
		}

		function clearAndRedraw(){
			clearBaloon();
			clearDivs();	
			clearSelection();	
			redraw();
		}

		//
		// Törli az információs felhőt
		//
		function clearBaloon(){

			if( popup ){
				map.removePopup(popup);
			}			
		}

		function clearSelection(){
		
			buildingIndividualUnitViewLayer.params.selected_nid = null
			parcelViewLayer.params.selected_nid =  null;
			buildingViewLayer.params.selected_nid =  null;
			pointViewLayer.params.selected_nid =  null;

		}

		function redraw(){
			pointViewLayer.redraw(true);
			parcelViewLayer.redraw(true);
			buildingViewLayer.redraw(true);
			buildingIndividualUnitViewLayer.redraw(true);
		}

		/** Törli az adatokat a DIV-ekből **/
		function clearDivs(){
			document.getElementById( "objectDataDIV" ).innerHTML = "";
			document.getElementById( "ownerListDIV" ).innerHTML = "";
			document.getElementById( "projectionPointsListDIV" ).innerHTML = "";
			document.getElementById( "objectPointsListDIV" ).innerHTML = "";
			document.getElementById( "X3DLinkDIV" ).innerHTML = "";
		}

    </script>

</head>

<body onLoad="init()"  bgcolor="#FFFFAA" text="#000000">

	<table border="1" >

		<!-- Felső, vezérlő szekció -->
		<tr>						
			
			<!-- Térkép -->
			<td >
				<div id="mapDiv" style="border: 1px solid black; width:600px; height:350px; background:gray" ></div>
			</td>

			<!-- Térkép jobb oldalán látható szekció -->
			<td valign="top" align="left">
				<table border="1">

					<!-- Vetületen megjelenő épületszint vezérlése -->
					<tr>
						<td>
							Vetületen megjelenő épületszint:
						</td>
						<td>
							<select id="building_level_selection">
								<option value="-2.0">-2. Szint</option>
								<option value="-1.0">-1. Szint</option>
								<option value="0.0">Földszint</option>
								<option value="1.0">1. Emelet</option>
								<option value="2.0">2. Emelet</option>
								<option value="3.0">3. Emelet</option>
							</select>
						</td>
					</tr>

					<!-- Vetületen megjelenő aluljárószint vezérlése -->
					<tr>
						<td>
							Vetületen megjelenő aluljárószint:
						</td>
						<td>
							<select id="underpass_level_selection">
								<option value="-2.0">-2. Szint</option>
								<option value="-1.0">-1. Szint</option>
							</select>
						</td>
					</tr>

					<!-- Ki/be kapcsolásokat vezérlő szekció-->					
					<form name="control" >
						<tr>						
							<td colspan="2">
								<table border="1">

									<!-- Buborék engedélyezésének ki/be kapcsolása -->
									<tr>
										<td>
											<input type="checkbox" name="bubble" value="bubble" unchecked >	Buborék engedélyezése:
										</td>	
									</tr>

									<!-- 3D model automatikus megjelenítésének ki/be kapcsolása -->
									<tr>
										<td>
											<input type="checkbox" name="3dmodel" value="3dmodel" checked>3D modell utomatikus megjelenése
										</td>
									</tr>
								</table>
							</td>
						<tr>
					</form>

					<!-- Layer-ek ki/be kapcsolását vezérlő szekció -->
					<tr>
						<td colspan="1">
							<div id="layerSwitcherDiv" class="olControlLayerSwitcher-"  style="border: 1px solid black;" ></div> 
						</td>
					<tr>

				</table>
			</td>
		</tr>
		<tr>
			<td colspan="2">
<!--				<div id="objectDataDIV" style="border: 1px solid black; height: 100px; width: 600px; font-family: arial; font-size: 12; overflow:auto;"></div> -->
				<div id="objectDataDIV" style="border: 0px solid black; font-family: arial; font-size: 12; overflow:auto;"></div>
			</td>			
		</tr>
		<tr>
			<td colspan="2">
				<div id="X3DLinkDIV" style="border: 0px solid black; font-family: arial; font-size: 12; overflow:auto;"></div>
			</td>			
		</tr>
		<tr>
		<tr>
			<td colspan="2">
<!--				<div id="ownerListDIV" style="border: 1px solid black; height: 100px; width: 600px; overflow:auto;"></div>  -->
				<div id="ownerListDIV" style="border: 0px solid black; max-height: 100px; overflow:auto;"></div>
			</td>
			</td>
		</tr>
		<tr>
			<td colspan="2">			
<!--				<div id="pointListDIV" style="border: 1px solid black; height: 140px; width: 600px; overflow:auto; "></div> -->
				<div id="projectionPointsListDIV" style="border: 0px solid black; max-height:140px; overflow:auto; "></div>
			</td>
		</tr>
		<tr>
			<td colspan="2">			
				<div id="objectPointsListDIV" style="border: 0px solid black; max-height:140px; overflow:auto; "></div>
			</td>
		</tr>

	</table>

</body>
</html>

