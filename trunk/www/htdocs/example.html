<!-- MapServer Template -->
<html>
<head>
	<title>MapServer 5.x Tutorial</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<script type="text/javascript" src="/tdc/proj4js/lib/proj4js.js"></script>
	<script type="text/javascript" src="/tdc/openlayers/OpenLayers.js"></script> 
	<script type="text/javascript" src="/tdc/jquery/jquery-1.8.1.js"></script>
	<script type="text/javascript" src="/tdc/xmlhttprequest/XMLHttpRequest.js"></script>

	<script type="text/javascript">

	// EOV vetület proj4-es definíciója. Figyelem: az EPSG adatbázisban hibásan szerepel, a dátumtranszformáció hiányzik belőle!
	Proj4js.defs["EPSG:2370"] = "+title=Hungarian EOV EPSG:2370 +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +x_0=650000 +y_0=200000 +ellps=GRS67 +datum=HD72 +towgs84=57.01,-69.97,-9.29 +units=m +no_defs"

	//MAP fajl eleresi utvonala
	var urlMap = "http://localhost/cgi-bin/mapserv?map=/home/akoel/Projects/tdc/svn/www/htdocs/example.map";

	//Vetuletek
//	var wgs84=new OpenLayers.Projection('EPSG:4326');
	var hd72=new OpenLayers.Projection('EPSG:2370');

	//MAP objektum
	var map;
	var popup;

	//View layer
	var parcelViewLayer;
	var buildingViewLayer;
	var buildingIndividualUnitViewLayer;

	//Query layer
	var identifyLayer;
	var queryBuildingIndividualUnitOwnerLayer;

var parcelPointViewLayer;

	var foundLayer = false;
	
	function init() {

		//-------------
		// MAP objektum
		//-------------
		map = new OpenLayers.Map('mapDiv',
		{
			projection: "EPSG:2370",
			//maxExtent: new OpenLayers.Bounds(410000, 45000, 950000, 360000), //Ez a teljes magyarorszag
//			maxExtent: new OpenLayers.Bounds(645407, 227808, 645670, 227959),  //Ez pedig a kijelolt telek
			maxExtent: new OpenLayers.Bounds(645200, 227760, 645700, 228050),  //Ez pedig a kijelolt telek
			//maxResolution: 901, //Ez magyarorszagra vonatkozo meret
                        maxResolution: 0.8,
			units: "m"
		});

		//---------
		// Controls
		//---------
		//map.addControl(new OpenLayers.Control.OverviewMap());

		//Layerek ki/be kapcsolasa
		map.addControl(new OpenLayers.Control.LayerSwitcher());

		//Leptek
		var scaleLine = new OpenLayers.Control.ScaleLine();
		map.addControl( scaleLine );

		//pozicio Control
		var posControl = new OpenLayers.Control.MousePosition({'numDigits':2, 'displayProjection': hd72, 'emptyString':''});
		map.addControl( posControl );

		//Meretarany	    
		var scaleControl = new OpenLayers.Control.Scale();
		map.addControl( scaleControl);
	    
//		var attribControl = new OpenLayers.Control.Attribution();
//		map.addControl( attribControl );


		//--------------------------------------------------------------------------------------------
		// A lathatosagi layerek
		//
		//  MapServer -nek kell lennie
		//--------------------------------------------------------------------------------------------

		parcelViewLayer = new OpenLayers.Layer.WMS( 
			"Földrészlet", 
			urlMap,
			{ layers:  "view_parcel", format: 'image/png' , parcel_nid: null },
			{ isBaseLayer: true, visibility: true, opacity: 1.0, transparent: 'true' }
		);

		buildingViewLayer = new OpenLayers.Layer.WMS( 
			"Épület", 
			urlMap,
			{ layers:  "view_building", format: 'image/png' , highlighted_building_nid: null },
			{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true' }				
		);

		buildingIndividualUnitViewLayer = new OpenLayers.Layer.WMS( 
			"Lakások", 
			urlMap,
			{ layers:  "wiev_building_individual_unit", format: 'image/png' , visible_building_level: '1.0', highlighted_unit_nid: null },
			{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true' }				
		);

		//Parameterek a MAP fajlnak, ha WMS layert hasznalok MapServer helyett
		buildingIndividualUnitViewLayer.params.visible_building_level='1.0';



/*		parcelPointViewLayer = new OpenLayers.Layer.WMS( 
			"Parcella pontok", 
			urlMap,
			{ layers:  "parcel_point_view", format: 'image/png' , building_nid: null },
			{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true'}				
		);
*/
		//---------------------------------------------------------------------------------------------
		// Lekerdezo layerek
		//
		// WMS -nek kell lennie
		//---------------------------------------------------------------------------------------------
		//visibility: false - Nem látható
		//displayInLayerSwithcer: false - Nem lesz látható a Layer Swicherben
		identifyLayer = new OpenLayers.Layer.WMS( 
			"Közös kérés", 
			urlMap,
			{ layers:  "identify_parcel,identify_building,identify_building_individual_unit", format: 'image/png' },
			{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
		);

		queryBuildingIndividualUnitOwnerLayer = new OpenLayers.Layer.WMS( 
			"query_building_individual_unit_owner", 
			urlMap,
			{ layers:  "query_building_individual_unit_owner", format: 'image/png',visible_building_level:'1.0' },
			{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
		);

		queryBuildingIndividualUnitOwnerLayer.params.visible_building_level='1.0';

		//Fontos a sorrend. A kovetkezo mindig az elozo felett van
		map.addLayer(identifyLayer);
		map.addLayer(queryBuildingIndividualUnitOwnerLayer);

		map.addLayer(parcelViewLayer);		
		map.addLayer(buildingViewLayer);
		map.addLayer(buildingIndividualUnitViewLayer);


		//map.addLayers([parcelViewLayer, buildingViewLayer, parcelPointViewLayer]);


//buildingViewLayer.setVisibility(false);
	    
		//===========	//
		//				//
		// Esemenykezeles	//
		//				//
		//===========	//
	    
		//---------------------------------------------------
		//Pozicio megjelenitese esemény
		//---------------------------------------------------
		map.events.register("click", map, function(e){
	        
/*			//Pozicio az ablak koordinata rendszereben
			var pxPos=map.events.getMousePosition(e);
	        
			//Pozicio az aktuális vetületi rendszerben
			var projPos=map.getLonLatFromPixel(pxPos);
	        
			//Pozicio wgs84 foldrajzi koordinatarendszerben
			var wgs84Pos=projPos.clone().transform(hd72,wgs84);
	        
			//Ellenorzeskepp visszaszamolun. termeszetesen ez nem kell
			var eovPos=projPos.clone().transform(hd72,hd72);
	                
			document.getElementById('posDiv').innerHTML="Page position: " + pxPos + "<br>" + "EOV: " + projPos + "<br>" + "WGS84: " + wgs84Pos + "<br>" + "hd72: " + eovPos;
*/

		}  );

		//---------------------------------
		//Kivalasztas esemény
		//---------------------------------
		map.events.register("click", map, function(e){
			var getInfoCommonURL=identifyLayer.getFullRequestString({
			REQUEST: "GetFeatureInfo",
			EXCEPTIONS: "application/vnd.ogc.se_xml",
			FORMAT: 'png',
			BBOX: map.getExtent().toBBOX(),
			X: e.xy.x,
			Y: e.xy.y,
			INFO_FORMAT: 'text/html',
			QUERY_LAYERS:  "identify_parcel,identify_building,identify_building_individual_unit", //Azok a layer-ek, amikrol infot akarok
			FEATURE_COUNT: 100,
			WIDTH: map.size.w,
			HEIGHT: map.size.h });
			OpenLayers.Request.POST({ url: getInfoCommonURL, callback: function(response){ highlightResult(response, e.xy )}});			
		});

	    //Terkep merete a maximalisra-Maximum ekkora lehet egy pixel
	    map.zoomToMaxExtent();
	    
	    //Pozicio div torlese
	    document.getElementById('posDiv').innerHTML="Page position:<br>" + "EOV:<br>" + "WGS84:<br>" + "hd72:";
	   
	};
	



	//-------------------------------------------------
	// Kiemelo fuggveny+azonosítás
	//-------------------------------------------------
	function highlightResult(response, xy){
		var xmlDoc = $.parseXML( "<block>" + response.responseText + "</block>" );
		var objs = $( $(xmlDoc)[0] ).find("object" );
		var toDiv = "<html><head></head><body>Kivalasztott elemek<br>"
		var selected_name;
		var selected_nid;
		var immovable_type;
		var building_individual_unit_level;
		var layerToQuery = "";
		var hasSelected = false;

		//Ha kattintottam de az nem objektum volt, akkor törli az összes kijelölést
		if( objs.length == 0 ){
			parcelViewLayer.params.parcel_nid =  null;
			buildingViewLayer.params.highlighted_building_nid =  null;
			layerToQuery = ""

		//Különben elvégzi a kijelölést
		}else{

			//Ha mar van nyitva popup, akkor azt lezarja
			if( popup ){
				map.removePopup(popup);
			}			

			
			//Ha a kijelölt objektum más objektummal tulajdoni viszonyban van
			//De ehhez előbb fentről lefele meg kell találni a kijelölt objektumot
			//Például ha egy házra kattintottam és az látható volt a térképen, akkor azt és az azzal kapcsolatos földterületet kell kijelölni  ???????????

			//Jelzem, hogy meg nem volt kivalasztott elem
			hasSelected = false;

			//BUILDING INDIVIDUAL UNIT vizsgálat - lakást választotam-e ki
			for( i = 0; i< objs.length; i++){

				//Álatlános paraméterek, Ezek már itt is léteznek
				selected_name = $(objs[ i ]).attr("selected_name");
				selected_nid = $(objs[ i ]).find("selected_nid")[0].textContent;				

				//Ha lakás volt és a layer-en latszik a lakás
				if( selected_name == "im_building_individual_unit"  && buildingIndividualUnitViewLayer.getVisibility()){

					//Ezek specifikus paraméterek, csak itt lehetek biztos benne, hogy léteznek
					selected_level = $(objs[ i ]).find("selected_level")[0].textContent;
					selected_settlement = $(objs[ i ]).find("selected_settlement")[0].textContent;
					selected_hrsz = $(objs[ i ]).find("selected_hrsz")[0].textContent;
					selected_registered_area = $(objs[ i ]).find("selected_registered_area")[0].textContent;
					selected_measured_area = $(objs[ i ]).find("selected_measured_area")[0].textContent;

					//Ha  a látható szinten választottam
					if( buildingIndividualUnitViewLayer.params.visible_building_level == selected_level ){

						//Buborkék előkészítése		
						var result = "<center>Társasházi lakás</center><br>";
						result += "Város: <b>" + selected_settlement + "</b><br>";
						result += "Hrsz: <b>" + selected_hrsz  + "</b><br>";
						result += "Nyilvántartott terület: <b>" + Math.round(selected_registered_area) + "</b> " + "m2<br>";
						result += "Mért terület: <b>" + Math.round(selected_measured_area) + "</b> " + "m2<br>";
	
						//Eredmeny egy buborekba a kivalasztott ponthoz
						popup = new OpenLayers.Popup.FramedCloud(
				                        "chick", 
				                        map.getLonLatFromPixel( xy ),
				                        null, //new OpenLayers.Size(100,300),
				                        result,
				                        null,
				                        true,
				                        null
				                   );

						//Elhelyezi a buborekot-a terkepen
						map.addPopup( popup );

						//Owner list query  a kivalasztott objektumrol
						var getInfo=queryBuildingIndividualUnitOwnerLayer.getFullRequestString({
							REQUEST: "GetFeatureInfo",
							EXCEPTIONS: "application/vnd.ogc.se_xml",
							FORMAT: 'png',
							BBOX: map.getExtent().toBBOX(),
							X: xy.x,
							Y: xy.y,
							INFO_FORMAT: 'text/html',
							QUERY_LAYERS: 'query_building_individual_unit_owner',
							FEATURE_COUNT: 10,
							WIDTH: map.size.w,
							HEIGHT: map.size.h });

						OpenLayers.Request.POST({ url: getInfo, callback: function(response){ 
document.getElementById( "dataDiv" ).innerHTML = response.responseText;
						}});























			

//Akkor a kijelolest allitja
buildingIndividualUnitViewLayer.params.highlighted_building_unit_nid =  selected_nid;
parcelViewLayer.params.parcel_nid =  null;
buildingViewLayer.params.highlighted_building_nid =  null;

						//Jelzem, hogy van kivalasztott elem
						hasSelected = true;
						break
					}
				}
			}//BUILDING for



			//BUILDING vizsgálat - Épületet választottam-e ki
			for( i = 0; !hasSelected && i< objs.length; i++){
	
				selected_name = $(objs[ i ]).attr("selected_name");
				selected_nid = $(objs[ i ]).find("selected_nid")[0].textContent;
				

				//Ha ház volt és a layer-en latszik a ház
				if( selected_name == "im_building"  && buildingViewLayer.getVisibility() ){

					immovable_type = $(objs[ i ]).find("immovable_type")[0].textContent;

					//Ha "1. Foldreszlet" volt
					if( immovable_type == 1 ){

document.getElementById( "dataDiv" ).innerHTML = "1. Földrészlet";

					//Ha "2. Foldreszlet hazzal" volt
					}else if( immovable_type == 2 ){

document.getElementById( "dataDiv" ).innerHTML = "2. Földrészlet épülettel együtt";

					//Ha "3. Foldreszlet kulonallo hazzal" volt
					}else if( immovable_type == 3 ){

document.getElementById( "dataDiv" ).innerHTML = "3. Földrészlet EÖI-ú épülettel ";

					//Ha "4. Tarsas haz" volt
					}else if( immovable_type == 4 ){
document.getElementById( "dataDiv" ).innerHTML = "4. Földrészlet társasházi lakásokkal";
					}

//Akkor a kijelolest allitja
buildingIndividualUnitViewLayer.params.highlighted_building_unit_nid = null
parcelViewLayer.params.parcel_nid =  null;
buildingViewLayer.params.highlighted_building_nid =  selected_nid;

					//Jelzem, hogy van kivalasztott elem
					hasSelected = true;
					break
				}
			}//BUILDING for

			//PARCEL vizsgalat - Földrészletet választottam-e ki
			for( i = 0; !hasSelected && i< objs.length; i++){
			
				selected_name = $(objs[ i ]).attr("selected_name");
				selected_nid = $(objs[ i ]).find("selected_nid")[0].textContent;				

				//Ha földrészlet volt és látszik a földrészlet (persze ez mindig látszik-de azért mégis vizsgálom)
				if( selected_name == "im_parcel"  && parcelViewLayer.getVisibility() ){

					immovable_type = $(objs[ i ]).find("immovable_type")[0].textContent;

//Akkor a kijelolest allitja
buildingIndividualUnitViewLayer.params.highlighted_building_unit_nid = null
parcelViewLayer.params.parcel_nid =  selected_nid;
buildingViewLayer.params.highlighted_building_nid =  null;

					//Ha "1. Foldreszlet" volt
					if( immovable_type == 1 ){

document.getElementById( "dataDiv" ).innerHTML = "1. Földrészlet";

					//Ha "2. Foldreszlet hazzal" volt
					}else if( immovable_type == 2 ){

document.getElementById( "dataDiv" ).innerHTML = "2. Földrészlet épülettel együtt";

					//Ha "3. Foldreszlet kulonallo hazzal" volt
					}else if( immovable_type == 3 ){

document.getElementById( "dataDiv" ).innerHTML = "3. Földrészlet EÖI-ú épülettel ";

					//Ha "4. Tarsas haz" volt
					}else if( immovable_type == 4 ){
document.getElementById( "dataDiv" ).innerHTML = "4. Földrészlet társasházi lakásokkal";
					}

					//Jelzem, hogy van kivalasztott elem
					hasSelected = true;
					break
				}
			}//PARCEL for

		}

parcelViewLayer.redraw( true );
buildingViewLayer.redraw( true );
buildingIndividualUnitViewLayer.redraw( true );

	}


    </script>

</head>

<body onLoad="init()"  bgcolor="#FFFFAA" text="#000000">

	<div id="posDiv"  style="border: 1px solid black; height: 100px; width: 600px"></div>

	<div id="mapDiv" style="width:600px; height:350px; background:red" ></div>
    
	<div id="dataDiv" style="border: 1px solid black; height: 120px; width: 600px"></div>

</body>
</html>

