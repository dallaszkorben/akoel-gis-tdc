<!-- MapServer Template -->
<html>
<head>
	<title>MapServer 5.x Tutorial</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<script type="text/javascript" src="/tdc/proj4js/lib/proj4js.js"></script>
	<script type="text/javascript" src="/tdc/openlayers/OpenLayers.js"></script> 
	<script type="text/javascript" src="/tdc/jquery/jquery-1.8.1.js"></script>
	<script type="text/javascript" src="/tdc/xmlhttprequest/XMLHttpRequest.js"></script>

	<script type="text/javascript">

	// EOV vetület proj4-es definíciója. Figyelem: az EPSG adatbázisban hibásan szerepel, a dátumtranszformáció hiányzik belőle!
	Proj4js.defs["EPSG:2370"] = "+title=Hungarian EOV EPSG:2370 +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +x_0=650000 +y_0=200000 +ellps=GRS67 +datum=HD72 +towgs84=57.01,-69.97,-9.29 +units=m +no_defs"

	//MAP fajl eleresi utvonala
	var urlMap = "http://localhost/cgi-bin/mapserv?map=/home/akoel/Projects/tdc/svn/www/htdocs/example.map";

	//Vetuletek
//	var wgs84=new OpenLayers.Projection('EPSG:4326');
	var hd72=new OpenLayers.Projection('EPSG:2370');

	//MAP objektum
	var map;
	var popup;

	var identifyLayer;
	var parcelViewLayer;
	var buildingViewLayer;
var parcelPointViewLayer;

	var foundLayer = false;
	
	function init() {

		//-------------
		// MAP objektum
		//-------------
		map = new OpenLayers.Map('mapDiv',
		{
			projection: "EPSG:2370",
			//maxExtent: new OpenLayers.Bounds(410000, 45000, 950000, 360000), //Ez a teljes magyarorszag
//			maxExtent: new OpenLayers.Bounds(645407, 227808, 645670, 227959),  //Ez pedig a kijelolt telek
			maxExtent: new OpenLayers.Bounds(645200, 227760, 645700, 228050),  //Ez pedig a kijelolt telek
			//maxResolution: 901, //Ez magyarorszagra vonatkozo meret
                        maxResolution: 0.8,
			units: "m"
		});

		//---------
		// Controls
		//---------
		//map.addControl(new OpenLayers.Control.OverviewMap());

		//Layerek ki/be kapcsolasa
		map.addControl(new OpenLayers.Control.LayerSwitcher());

		//Leptek
		var scaleLine = new OpenLayers.Control.ScaleLine();
		map.addControl( scaleLine );

		//pozicio Control
		var posControl = new OpenLayers.Control.MousePosition({'numDigits':2, 'displayProjection': hd72, 'emptyString':''});
		map.addControl( posControl );

		//Meretarany	    
		var scaleControl = new OpenLayers.Control.Scale();
		map.addControl( scaleControl);
	    
//		var attribControl = new OpenLayers.Control.Attribution();
//		map.addControl( attribControl );


		//--------------------------------------------------------------------------------------------
		// A lathatosagi layerek
		//
		//  MapServer -nek kell lennie
		//--------------------------------------------------------------------------------------------

		parcelViewLayer = new OpenLayers.Layer.WMS( 
			"Földrészlet", 
			urlMap,
			{ layers:  "parcel_view", format: 'image/png' , parcel_nid: null },
			{ isBaseLayer: true, visibility: true, opacity: 1.0, transparent: 'true' }
		);

		buildingViewLayer = new OpenLayers.Layer.WMS( 
			"Épület", 
			urlMap,
			{ layers:  "building_view", format: 'image/png' , building_nid: null },
			{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true' }				
		);

		parcelPointViewLayer = new OpenLayers.Layer.WMS( 
			"Parcella pontok", 
			urlMap,
			{ layers:  "parcel_point_view", format: 'image/png' , building_nid: null },
			{ isBaseLayer: false, alpha:true, visibility: true, opacity: 1.0, transparent: 'true'}				
		);

		//---------------------------------------------------------------------------------------------
		// Lekerdezo layerek
		//
		// WMS -nek kell lennie
		//---------------------------------------------------------------------------------------------
		//visibility: false - Nem látható
		//displayInLayerSwithcer: false - Nem lesz látható a Layer Swicherben
		identifyLayer = new OpenLayers.Layer.WMS( 
			"Közös kérés", 
			urlMap,
			{ layers:  "parcel_identify,building_identify", format: 'image/png' },
			{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true, displayInLayerSwitcher: false }				
		);


		//Fontos a sorrend. A kovetkezo mindig az elozo felett van
		map.addLayer(identifyLayer);
		map.addLayer(parcelViewLayer);
		map.addLayer(buildingViewLayer);
		//map.addLayers([parcelViewLayer, buildingViewLayer, parcelPointViewLayer]);


//buildingViewLayer.setVisibility(false);
	    
		//===========	//
		//				//
		// Esemenykezeles	//
		//				//
		//===========	//
	    
		//---------------------------------------------------
		//Pozicio megjelenitese esemény
		//---------------------------------------------------
		map.events.register("click", map, function(e){
	        
/*			//Pozicio az ablak koordinata rendszereben
			var pxPos=map.events.getMousePosition(e);
	        
			//Pozicio az aktuális vetületi rendszerben
			var projPos=map.getLonLatFromPixel(pxPos);
	        
			//Pozicio wgs84 foldrajzi koordinatarendszerben
			var wgs84Pos=projPos.clone().transform(hd72,wgs84);
	        
			//Ellenorzeskepp visszaszamolun. termeszetesen ez nem kell
			var eovPos=projPos.clone().transform(hd72,hd72);
	                
			document.getElementById('posDiv').innerHTML="Page position: " + pxPos + "<br>" + "EOV: " + projPos + "<br>" + "WGS84: " + wgs84Pos + "<br>" + "hd72: " + eovPos;
*/

		}  );

		//---------------------------------
		//Kivalasztas esemény
		//---------------------------------
		map.events.register("click", map, function(e){
			var getInfoCommonURL=identifyLayer.getFullRequestString({
			REQUEST: "GetFeatureInfo",
			EXCEPTIONS: "application/vnd.ogc.se_xml",
			FORMAT: 'png',
			BBOX: map.getExtent().toBBOX(),
			X: e.xy.x,
			Y: e.xy.y,
			INFO_FORMAT: 'text/html',
				//QUERY_LAYERS:  "building_query_selected,parcel_query_selected",
				//QUERY_LAYERS:  "building_query,parcel_query", //Azok a layer-ek, amikrol infot akarok
			QUERY_LAYERS:  "parcel_identify,building_identify", //Azok a layer-ek, amikrol infot akarok
			FEATURE_COUNT: 1,
			WIDTH: map.size.w,
			HEIGHT: map.size.h });
			OpenLayers.Request.POST({ url: getInfoCommonURL, callback: function(response){ highlightResult(response, e.xy )}});			
		});

	    //Terkep merete a maximalisra-Maximum ekkora lehet egy pixel
	    map.zoomToMaxExtent();
	    
	    //Pozicio div torlese
	    document.getElementById('posDiv').innerHTML="Page position:<br>" + "EOV:<br>" + "WGS84:<br>" + "hd72:";
	   
	};
	



	//------------------------------
	// Kiemelo fuggveny
	//------------------------------
	function highlightResult(response, xy){
		var xmlDoc = $.parseXML( "<block>" + response.responseText + "</block>" );
		var objs = $( $(xmlDoc)[0] ).find("object" );
		var toDiv = "<html><head></head><body>Kivalasztott elemek<br>"

		var selected_name;
		var selected_nid;
		var layerToQuery = "";

		//Ha kattintottam de az nem objektum volt, akkor törli az összes kijelölést
		if( objs.length == 0 ){
			parcelViewLayer.params.parcel_nid =  null;
			buildingViewLayer.params.building_nid =  null;
			buildingViewLayer.redraw( true );
			layerToQuery = ""

		//Különben elvégzi a kijelölést
		}else{
			
			//Ha a kijelölt objektum más objektummal tulajdoni viszonyban van
			//De ehhez előbb fentről lefele meg kell találni a kijelölt objektumot
			//Például ha egy házra kattintottam és az látható volt a térképen, akkor azt és az azzal kapcsolatos földterületet kell kijelölni

			//BUILDING - Vegig az osszes "object" elemen 
			for( i = 0; i< objs.length; i++){
			
				selected_name = $(objs[ i ]).attr("selected_name");
				selected_nid = $(objs[ i ]).find("selected_nid")[0].textContent;

				//Ha ház volt
				if( selected_name == "building"  && buildingViewLayer.getVisibility() ){
					buildingViewLayer.params.building_nid =  selected_nid;
					parcelViewLayer.params.parcel_nid =  null;
					break
				}
			}//for

			parcelViewLayer.redraw( true );
			buildingViewLayer.redraw( true );

		}

/*
		//Vegig az osszes "object" elemen
		for( i = 0; i< objs.length; i++){
			
			objectName = $(objs[ i ]).attr("name");
			objectId = $(objs[ i ]).find("id")[0].textContent;

			//Objektum kiemelese
			if( objectName == "parcel" && parcelViewLayer.getVisibility() ){
				parcelViewLayer.params.parcel_nid =  objectId;
				buildingViewLayer.params.building_nid =  null;
//				parcelViewLayer.redraw( true );
				layerToQuery = "parcel_query"
				break;
			}else if( objectName == "building"  && buildingViewLayer.getVisibility()){
				buildingViewLayer.params.building_nid =  objectId;
				buildingViewLayer.params.parcel_nid =  null;
//				buildingViewLayer.redraw( true );
				layerToQuery = "building_query"
				break;
			}else{
				parcelViewLayer.params.parcel_nid =  null;
				buildingViewLayer.params.building_nid =  null;
//				buildingViewLayer.redraw( true );
				layerToQuery = ""
			}

			//Megjelenitem
			toDiv +=  "Objektum: <b>" + objectName + "</b>   azonosito: <b>" + objectId  + "</b><br>";
		}

		parcelViewLayer.redraw( true );
		buildingViewLayer.redraw( true );
}
*/


/*
		//Megjelenites a dataDiv-ben
		toDiv += "</body></html>"
		document.getElementById( "dataDiv" ).innerHTML = toDiv;



		//Ha mar van nyitva popup, akkor azt lezarja
		if( popup ){
			map.removePopup(popup);
		}			
		

		//Query keres a kivalasztott objektumrol
		var getInfo=queryLayer.getFullRequestString({
				REQUEST: "GetFeatureInfo",
				EXCEPTIONS: "application/vnd.ogc.se_xml",
				FORMAT: 'png',
				BBOX: map.getExtent().toBBOX(),
				X: xy.x,
				Y: xy.y,
				INFO_FORMAT: 'text/html',
				QUERY_LAYERS:  layerToQuery, //Ha tobb layert akarok lekerni, akkor vesszovel elvalasztva kell felsorolni
				FEATURE_COUNT: 1,
				WIDTH: map.size.w,
				HEIGHT: map.size.h });
		OpenLayers.Request.POST({ url: getInfo, callback: function(response){ 

			//Eredmeny egy buborekba a kivalasztott ponthoz
			popup = new OpenLayers.Popup.FramedCloud(
	                        "chick", 
	                        map.getLonLatFromPixel( xy ),
	                        null, //new OpenLayers.Size(100,300),
	                        response.responseText,
	                        null,
	                        true,
	                        null
	                   );

			//Elhelyezi a buborekot-a terkepen
			map.addPopup( popup );
		}});
*/


	}



	//---------------------
	//Eredmeny kiiras
	//---------------------	
	function showResult(response, xy){

		//Eredmeny egy  DIV-be, a térkép alatt
		//document.getElementById("dataDiv").innerHTML =  response.responseText ;

		var xmlDoc = $.parseXML( "<block>" + response.responseText + "</block>" );

		var objs = $( $(xmlDoc)[0] ).find("object" );
	
		var toDiv = "<html><head></head><body>Kivalasztott elemek<br>"

		var objectName;
		var objectId;
		var layerToQuery = "";

		//Vegig az osszes "object" elemen
		for( i = 0; i< objs.length; i++){
			
			objectName = $(objs[ i ]).attr("name");
			objectId = $(objs[ i ]).find("id")[0].textContent;

			toDiv +=  "Objektum: <b>" + objectName + "</b>   azonosito: <b>" + objectId  + "</b><br>";

		}

		//Megjelenites a dataDiv-ben
		toDiv += "</body></html>"
		document.getElementById( "dataDiv" ).innerHTML = toDiv;

		//Objektum kiemeles
		if( objectName == "parcel" ){
			viewLayer.params.parcel_gid =  objectId;
			viewLayer.params.building_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = "parcel_query"
		}else if( objectName == "building" ){
			viewLayer.params.building_gid =  objectId;
			viewLayer.params.parcel_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = "building_query"
		}else{
			viewLayer.params.parcel_gid =  null;
			viewLayer.params.building_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = ""
		}

		//Ha mar van nyitva popup, akkor azt lezarja
		if( popup ){
			map.removePopup(popup);
		}			
		

		//Query keres a kivalasztott objektumrol
		var getInfo=queryLayer.getFullRequestString({
				REQUEST: "GetFeatureInfo",
				EXCEPTIONS: "application/vnd.ogc.se_xml",
				FORMAT: 'png',
				BBOX: map.getExtent().toBBOX(),
				X: xy.x,
				Y: xy.y,
				INFO_FORMAT: 'text/html',
				QUERY_LAYERS:  layerToQuery, //Ha tobb layert akarok lekerni, akkor vesszovel elvalasztva kell felsorolni
				FEATURE_COUNT: 1,
				WIDTH: map.size.w,
				HEIGHT: map.size.h });
		OpenLayers.Request.POST({ url: getInfo, callback: function(response){ 

			//Eredmeny egy buborekba a kivalasztott ponthoz
			popup = new OpenLayers.Popup.FramedCloud(
	                        "chick", 
	                        map.getLonLatFromPixel( xy ),
	                        null, //new OpenLayers.Size(100,300),
	                        response.responseText,
	                        null,
	                        true,
	                        null
	                   );

			//Elhelyezi a buborekot-a terkepen
			map.addPopup( popup );
		}});
	}


    </script>

</head>

<body onLoad="init()"  bgcolor="#FFFFAA" text="#000000">

	<div id="posDiv"  style="border: 1px solid black; height: 100px; width: 600px"></div>

	<div id="mapDiv" style="width:600px; height:350px; background:red" ></div>
    
	<div id="dataDiv" style="border: 1px solid black; height: 120px; width: 600px"></div>

</body>
</html>

