<!-- MapServer Template -->
<html>
<head>
	<title>MapServer 5.x Tutorial</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<script type="text/javascript" src="/tdc/proj4js/lib/proj4js.js"></script>
	<script type="text/javascript" src="/tdc/openlayers/OpenLayers.js"></script> 
	<script type="text/javascript" src="/tdc/jquery/jquery-1.8.1.js"></script>
	<script type="text/javascript" src="/tdc/xmlhttprequest/XMLHttpRequest.js"></script>

	<script type="text/javascript">

	// EOV vetület proj4-es definíciója. Figyelem: az EPSG adatbázisban hibásan szerepel, a dátumtranszformáció hiányzik belőle!
	Proj4js.defs["EPSG:2370"] = "+title=Hungarian EOV EPSG:2370 +proj=somerc +lat_0=47.14439372222222 +lon_0=19.04857177777778 +x_0=650000 +y_0=200000 +ellps=GRS67 +datum=HD72 +towgs84=57.01,-69.97,-9.29 +units=m +no_defs"

	//Vetuletek
	var wgs84=new OpenLayers.Projection('EPSG:4326');
	var hd72=new OpenLayers.Projection('EPSG:2370');

	var map;
	var popup;
	var queryLayer;
	var viewLayer;

	var foundLayer = false;
	var gid = 1;
	
	function init() {

		//-------------
		// MAP objektum
		//-------------
		map = new OpenLayers.Map('mapDiv',
		{
			projection: "EPSG:2370",
//			maxExtent: new OpenLayers.Bounds(410000, 45000, 950000, 360000), //Ez a teljes magyarorszag
			maxExtent: new OpenLayers.Bounds(645407, 227808, 645670, 227959),  //Ez pedig a kijelolt telek
			maxResolution: 910,
			units: "m"
		});

		//---------
		// Controls
		//---------
		//map.addControl(new OpenLayers.Control.OverviewMap());
		//map.addControl(new OpenLayers.Control.LayerSwitcher());

		var scaleLine = new OpenLayers.Control.ScaleLine();
		map.addControl( scaleLine );

		//pozicio Control
		var posControl = new OpenLayers.Control.MousePosition({'numDigits':2, 'displayProjection': hd72, 'emptyString':''});
		map.addControl( posControl );

		//Meretarany	    
		var scaleControl = new OpenLayers.Control.Scale();
		map.addControl( scaleControl);
	    
		var attribControl = new OpenLayers.Control.Attribution();
		map.addControl( attribControl );

		//---------
		// Layer-ek
		//---------

		queryLayer = new OpenLayers.Layer.WMS( 
			"Kozos", 
			"http://localhost/cgi-bin/mapserv?map=/home/akoel/Projects/tdc/svn/www/htdocs/example.map",
//			{ layers:  "parcel_query_selected,building_query_selected", format: 'image/png' },
			{ layers:  "parcel_query,building_query", format: 'image/png' },
			{ isBaseLayer: false, visibility: false, opacity: 1.0, transparent: true }				
		);

		viewLayer = new OpenLayers.Layer.MapServer( 
			"Kozos", 
			"http://localhost/cgi-bin/mapserv?map=/home/akoel/Projects/tdc/svn/www/htdocs/example.map",
//			{ layers:  "building_view", format: 'image/png' , gid: 1 },
			{ layers:  "parcel_view,building_view", format: 'image/png' , gid: 1 },
			{ isBaseLayer: true, visibility: false, opacity: 1.0, transparent: true }				
		);


		//Fontos a sorrend. A kovetkezo mindig az elozo felett van
		map.addLayers([queryLayer]);
		map.addLayers([viewLayer]);
	    
		//---------------
		// Esemenykezeles
		//---------------
	    
		//---------------------
		//Pozicio megjelenitese
		//---------------------
		map.events.register("click", map, function(e){
	        
			//Pozicio az ablak koordinata rendszereben
			var pxPos=map.events.getMousePosition(e);
	        
			//Pozicio az aktuális vetületi rendszerben
			var projPos=map.getLonLatFromPixel(pxPos);
	        
			//Pozicio wgs84 foldrajzi koordinatarendszerben
			var wgs84Pos=projPos.clone().transform(hd72,wgs84);
	        
			//Ellenorzeskepp visszaszamolun. termeszetesen ez nem kell
			var eovPos=projPos.clone().transform(hd72,hd72);
	                
			document.getElementById('posDiv').innerHTML="Page position: " + pxPos + "<br>" + "EOV: " + projPos + "<br>" + "WGS84: " + wgs84Pos + "<br>" + "hd72: " + eovPos;
		}  );



		//---------------------
		//Megtudja, hogy milyen elemek lettek kivalasztva
		//---------------------
		map.events.register( "click", map, function(e){

			var getInfoCommonURL=queryLayer.getFullRequestString({
				REQUEST: "GetFeatureInfo",
				EXCEPTIONS: "application/vnd.ogc.se_xml",
				FORMAT: 'png',
				BBOX: map.getExtent().toBBOX(),
				X: e.xy.x,
				Y: e.xy.y,
				INFO_FORMAT: 'text/html',
				QUERY_LAYERS:  "building_query_selected,parcel_query_selected",
				//QUERY_LAYERS:  "building_query,parcel_query", //Azok a layer-ek, amikrol infot akarok
				FEATURE_COUNT: 1,
				WIDTH: map.size.w,
				HEIGHT: map.size.h });
			OpenLayers.Request.POST({ url: getInfoCommonURL, callback: function(response){ showResult(response, e.xy )}});
		});


/*		//---------------------
		//Kiemeles
		//---------------------
		map.events.register( "click", map, function(e){

			gid++;
			viewLayer.params.parcel_gid =  gid;
			viewLayer.redraw( true );
		});
*/
	    //Terkep merete a maximalisra-Maximum ekkora lehet egy pixel
	    map.zoomToMaxExtent();
	    
	    //Pozicio div torlese
	    document.getElementById('posDiv').innerHTML="Page position:<br>" + "EOV:<br>" + "WGS84:<br>" + "hd72:";
	   
	};
	


	//---------------------
	//Eredmeny kiiras
	//---------------------	
	function showResult(response, xy){

		//Eredmeny egy  DIV-be, a térkép alatt
		//document.getElementById("dataDiv").innerHTML =  response.responseText ;

		var xmlDoc = $.parseXML( "<block>" + response.responseText + "</block>" );

		var objs = $( $(xmlDoc)[0] ).find("object" );
	
		var toDiv = "<html><head></head><body>Kivalasztott elemek<br>"

		var objectName;
		var objectId;
		var layerToQuery = "";

		//Vegig az osszes "object" elemen
		for( i = 0; i< objs.length; i++){
			
			objectName = $(objs[ i ]).attr("name");
			objectId = $(objs[ i ]).find("id")[0].textContent;

			toDiv +=  "Objektum: <b>" + objectName + "</b>   azonosito: <b>" + objectId  + "</b><br>";

		}

		//Megjelenites a dataDiv-ben
		toDiv += "</body></html>"
		document.getElementById( "dataDiv" ).innerHTML = toDiv;

		//Objektum kiemeles
		if( objectName == "parcel" ){
			viewLayer.params.parcel_gid =  objectId;
			viewLayer.params.building_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = "parcel_query"
		}else if( objectName == "building" ){
			viewLayer.params.building_gid =  objectId;
			viewLayer.params.parcel_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = "building_query"
		}else{
			viewLayer.params.parcel_gid =  null;
			viewLayer.params.building_gid =  null;
			viewLayer.redraw( true );
			layerToQuery = ""
		}

		//Ha mar van nyitva popup, akkor azt lezarja
		if( popup ){
			map.removePopup(popup);
		}			
		

		//Query keres a kivalasztott objektumrol
		var getInfo=queryLayer.getFullRequestString({
				REQUEST: "GetFeatureInfo",
				EXCEPTIONS: "application/vnd.ogc.se_xml",
				FORMAT: 'png',
				BBOX: map.getExtent().toBBOX(),
				X: xy.x,
				Y: xy.y,
				INFO_FORMAT: 'text/html',
				QUERY_LAYERS:  layerToQuery, //Ha tobb layert akarok lekerni, akkor vesszovel elvalasztva kell felsorolni
				FEATURE_COUNT: 1,
				WIDTH: map.size.w,
				HEIGHT: map.size.h });
		OpenLayers.Request.POST({ url: getInfo, callback: function(response){ 

			//Eredmeny egy buborekba a kivalasztott ponthoz
			popup = new OpenLayers.Popup.FramedCloud(
	                        "chick", 
	                        map.getLonLatFromPixel( xy ),
	                        null, //new OpenLayers.Size(100,300),
	                        response.responseText,
	                        null,
	                        true,
	                        null
	                   );

			//Elhelyezi a buborekot-a terkepen
			map.addPopup( popup );
		}});
	}


    </script>

</head>

<body onLoad="init()"  bgcolor="#FFFFAA" text="#000000">

	<div id="posDiv"  style="border: 1px solid black; height: 100px; width: 600px"></div>

	<div id="mapDiv" style="width:600px; height:350px; background:red" ></div>
    
	<div id="dataDiv" style="border: 1px solid black; height: 120px; width: 600px"></div>

</body>
</html>

